<!DOCTYPE html>
<html>
  <head>
    <base target="_blank">
    <title>Docker Workshop</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);
      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
        margin-top: 0.5em;
      }
      a {
        text-decoration: none;
        color: blue;
      }
      .remark-slide-content { padding: 1em 2.5em 1em 2.5em; }
      .remark-slide-content { font-size: 25px; }
      .remark-slide-content h1 { font-size: 50px; }
      .remark-slide-content h2 { font-size: 50px; }
      .remark-slide-content h3 { font-size: 20px; }
      .remark-code { font-size: 20px; }
      .small .remark-code { font-size: 16px; }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .red { color: #fa0000; }
      .gray { color: #ccc; }
      .small { font-size: 70%; }
      .big { font-size: 140%; }
      .underline { text-decoration: underline; }
      .pic {
        vertical-align: middle;
        text-align: center;
        padding: 0 0 0 0 !important;
      }
      img {
        max-width: 100%;
        max-height: 550px;
      }
      .title {
        vertical-align: middle;
        text-align: center;
      }
      .title h1 { font-size: 100px; }
      .title p { font-size: 100px; }
      .quote {
        background: #eee;
        border-left: 10px solid #ccc;
        margin: 1.5em 10px;
        padding: 0.5em 10px;
        quotes: "\201C""\201D""\2018""\2019";
        font-style: italic;
      }
      .quote:before {
        color: #ccc;
        content: open-quote;
        font-size: 4em;
        line-height: 0.1em;
        margin-right: 0.25em;
        vertical-align: -0.4em;
      }
      .quote p {
        display: inline;
      }
      .warning {
        background-image: url("warning.png");
        background-size: 1.5em;
        background-repeat: no-repeat;
        padding-left: 2em;
      }
      .exercise {
        background-color: #eee;
        background-image: url("keyboard.png");
        background-size: 1.1em;
        background-repeat: no-repeat;
        background-position: 0.2em 0.2em;
        font-size: 20px;
        ##border: 2px dotted black;
        
      }
      .exercise::before {
        content: "";
        margin-left: 1.8em;
      }
      li p { line-height: 1.25em; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: title

Docker <br/> Workshop

---

## Sommaire

* Concept et théorique de Docker <img src="https://cloud.githubusercontent.com/assets/6421175/18341385/080cecc4-75aa-11e6-8392-7efbb01320e5.png" width="80">
* Conception d'une image et déploiement des containers <img src="https://cloud.githubusercontent.com/assets/6421175/18341737/b3a1b974-75ab-11e6-85d1-80d076babb09.png" width="80">
* Orchestration <img src="https://cloud.githubusercontent.com/assets/6421175/18341853/44295470-75ac-11e6-97b0-af6f6c73317c.png" width="70">
* Mise en place d'une usine logiciel orientée WebSIG
<img src="https://cloud.githubusercontent.com/assets/6421175/18341011/41a9ecae-75a8-11e6-9387-43945c30435c.png" width="70">
<img src="https://cloud.githubusercontent.com/assets/6421175/18341356/e8293e3a-75a9-11e6-8de7-165f68b17d75.png" width="50">
<img src="https://cloud.githubusercontent.com/assets/6421175/18341274/8fd6c57c-75a9-11e6-9e57-bf330d4dfecc.png" width="50">
<img src="https://cloud.githubusercontent.com/assets/6421175/18341093/a530766c-75a8-11e6-939c-4d3d6e96bf3c.png" width="50">
<img src="https://cloud.githubusercontent.com/assets/6421175/18341331/d023bb08-75a9-11e6-844f-55da3afbab9e.png" width="50">
<img src="https://cloud.githubusercontent.com/assets/6421175/18341127/d09ce4e8-75a8-11e6-91ce-b490e9ce5757.png" width="50">
<img src="https://cloud.githubusercontent.com/assets/6421175/18341170/060f6970-75a9-11e6-8263-fb830795c5d2.png" width="50">

---

## Concept et théorique de Docker <img src="https://cloud.githubusercontent.com/assets/6421175/18341385/080cecc4-75aa-11e6-8392-7efbb01320e5.png" width="100">

Docker est un logiciel libre (sous licence Apache 2.0) à mi-chemin entre la virtualisation applicative et l'automatisation. Il permet de manipuler des conteneurs de logiciels. Il complète le conteneur Linux LXC en isolant les processus les uns des autres pour créer une virtualisation de haut niveau. 

Dans l'esprit docker: un processus = un conteneur.

Contrairement aux autres systèmes de (para) virtualisation, Docker n’embarque pas un système d’exploitation invité mais ne s’occupe que de la partie haut niveau. Il utilise le noyau de l'hôte et ne fait fonctionner que le strict nécessaire sur les invités.

---

##Fonctionnement de Docker vs virtualisation :

<img src="https://cloud.githubusercontent.com/assets/6421175/18343006/bf153dd4-75b1-11e6-83e5-4189e3018ad6.png" width="750">

Docker c'est aussi un dépôt d'images à partir duquel vous pouvez télécharger et partager des applications sans avoir à réinventer la roue. 

---

##Exemple  d'architecture d'un serveur WebSIG sous Docker:

<img src="https://cloud.githubusercontent.com/assets/6421175/18342843/ffbebfb4-75b0-11e6-82f1-3689d2c35825.jpg" width="650">

L'hôte héberge quelques services, Docker et les fichiers de données persistantes. L'ensemble des applications sont containerisées, permettant souplesse et rapidité d'installation.

---

##Installation de docker linux ubuntu/Debian:

```
  sudo apt-get install apt-transport-https ca-certificates
  sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 \
  		   --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
  sudo nano /etc/apt/sources.list.d/docker.list

		# add
		deb https://apt.dockerproject.org/repo ubuntu-trusty main
		#ctrl o

  sudo apt-get update
  sudo apt-get purge lxc-docker
  apt-cache policy docker-engine
  sudo apt-get install linux-image-extra-$(uname -r) linux-image-extra-virtual
  sudo apt-get install docker-engine
  sudo service docker start
  sudo groupadd docker
  sudo usermod -aG docker $USER
  
```
https://docs.docker.com/engine/installation/

---

##Commandes essentielles de Docker: images

- Construire l'image via mon dépôt github (permet de voir toute l'installation, debug):  `docker docker build -t docker-lizmap git://github.com/jancelin/docker-lizmap`

- Construire l'image venant de DockerHub: `docker pull jancelin/docker-lizmap`

- Recherche sur DockerHub: `docker search lizmap`

- Lister les images chargés: `docker images`

- Supprimer une image: `docker rmi jancelin/docker-lizmap`

 https://docs.docker.com/engine/reference/commandline/#the-docker-commands 

---

##Commandes essentielles de Docker: container

- Démarrer une image, attribuer un port, lier un dossier en lecture: 

`docker run --restart="always" --name "websig-lizmap" -p 8081:80 -d -v /your_qgis_folder:/home:ro  jancelin/docker-lizmap`

- Lister les containers: `docker ps -a `

- Démarrer un container: `docker start name_container`

- Arrêter container:`docker stop name_container`

- Supprime le container:`docker rm name_container`

- Rentrer dans un container: `docker exec -it jancelin/docker-lizmap bash`

 https://docs.docker.com/engine/reference/commandline/#the-docker-commands 
 
 https://docs.docker.com/v1.8/reference/commandline/run/
 
---

##Jouer avec un premier container: un service web "Hello world"

.exercise[
```bash
docker run --name "hello" -p 8081:80 -d eeacms/hello
```
- Que c'est t'il passé?
```bash
docker images
docker ps
```
- Allez à: http://localhost:8081
```bash
docker stop hello && docker rm hello
docker ps
```
]
source: https://hub.docker.com/r/eeacms/hello/



---

##Conception d'une image et déploiement des containers <img src="https://cloud.githubusercontent.com/assets/6421175/18341737/b3a1b974-75ab-11e6-85d1-80d076babb09.png" width="100">

- Création du Dockerfile:

L'écriture d'un Dockerfile ressemble un peu à celle d'une recette de cuisine: incorporer ça, faire ça, incorporer autre chose, faire cette opération et cette autre opération.

<img src="https://cloud.githubusercontent.com/assets/6421175/18507558/25caf460-7a71-11e6-9e55-a36eafa499dd.png" width="400">

---

##Mots clefs de base pour la création d'un container 1/2: 

- FROM permet de définir depuis quelle base votre image ve être créée

- MAINTAINER permet de définir l'auteur de l'image et s'écrit de la manière suivante Nom <email>
	
- RUN permet de lancer une commande, mais aura aussi pour effet de créer une image intermédiaire.

- ADD permet de copier un fichier depuis la machine hôte ou depuis une URL

- EXPOSE permet d'exposer un port du container vers l'extérieur

---

##Mots clefs de base pour la création d'un container 2/2: 

- CMD détermine la commande qui sera exécutée lorsque le container démarrera

- ENTRYPOINT permet d'ajouter une commande qui sera exécutée par défaut, et ce, même si on choisit d'exécuter une commande différente de la commande standard

- WORKDIR permet de définir le dossier de travail pour toutes les autres commandes (par exemple RUN, CMD, ENTRYPOINT et ADD)

- ENV permet de définir des variables d'environnements qui pourront ensuite être modifiées grâce au paramètre de la commande run --env <key>=<value>.

- VOLUMES permet de créer un point de montage qui permettra de persister les données. On pourra alors choisir de monter ce volume dans un dossier spécifique en utilisant la commande `run -v :

---

##Mon premier Container:

- Conception d'un serveur web fonctionnel (apache) pour publier mes cartes (Qgis2web)

<img src="https://cloud.githubusercontent.com/assets/6421175/18508306/f2e957fa-7a73-11e6-9c5c-05fcf888598d.png" width="200">
<img src="https://cloud.githubusercontent.com/assets/6421175/18508320/f955b4f8-7a73-11e6-9aeb-275f88748be6.png" width="100">

https://plugins.qgis.org/plugins/qgis2web/

---

##Let's go: Créer un fichier Dockerfile et rajouter

.exercise[

FROM debian:jessie

MAINTAINER Julien ANCELIN

RUN apt-get update && apt-get -y install apache2 && apt-get clean && rm -rf /var/lib/apt/lists/*

ENV APACHE_RUN_USER www-data

ENV APACHE_RUN_GROUP www-data

ENV APACHE_LOG_DIR /var/log/apache2

RUN /usr/sbin/a2ensite default-ssl

RUN /usr/sbin/a2enmod ssl

EXPOSE 80

EXPOSE 443

CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]

]

---

class: title

# Merci! <br/> Questions?

## [@jancelin](https://twitter.com/complementterre)

    </textarea>
    <script src="remark-0.13.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create({
        ratio: '16:9',
        highlightSpans: true
      });
    </script>
  </body>
</html>
